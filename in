<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤ªé™½å…‰ç™ºé›»åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
    }

    header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
    }

    h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .upload-area {
        background: white;
        border-radius: 15px;
        padding: 40px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        text-align: center;
        cursor: pointer;
        border: 3px dashed #667eea;
        transition: all 0.3s;
    }

    .upload-area:hover {
        border-color: #764ba2;
        background: #f8f9ff;
    }

    .upload-icon {
        font-size: 3em;
        margin-bottom: 10px;
        color: #667eea;
    }

    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        transition: transform 0.3s;
    }

    .card:hover {
        transform: translateY(-5px);
    }

    .card-gradient-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .card-gradient-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
    .card-gradient-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
    .card-gradient-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
    .card-gradient-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; }

    .card-title {
        font-size: 0.9em;
        opacity: 0.9;
        margin-bottom: 10px;
    }

    .card-value {
        font-size: 2.5em;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .card-subtitle {
        font-size: 0.8em;
        opacity: 0.8;
    }

    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .chart-title {
        font-size: 1.5em;
        font-weight: bold;
        color: #333;
        margin-bottom: 20px;
    }

    canvas {
        max-height: 400px;
    }

    .table-container {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
    }

    td {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
    }

    tr:hover {
        background: #f8f9ff;
    }

    .weather-cell {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .weather-icon {
        font-size: 1.5em;
    }

    .hidden {
        display: none;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: white;
        font-size: 1.2em;
    }

    input[type="file"] {
        display: none;
    }

    @media (max-width: 768px) {
        h1 {
            font-size: 1.8em;
        }
        
        .summary-cards {
            grid-template-columns: 1fr;
        }
        
        .card-value {
            font-size: 2em;
        }
    }
</style>
```

</head>
<body>
    <div class="container">
        <header>
            <h1>â˜€ï¸ å¤ªé™½å…‰ç™ºé›»åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <p>è©³ç´°ãªç™ºé›»ãƒ‡ãƒ¼ã‚¿ã¨çµŒæ¸ˆåˆ†æ</p>
        </header>

```
    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <div class="upload-icon">ğŸ“</div>
        <h2>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
        <p>å¹´ã€æœˆã€æ—¥ã€æ™‚é–“ã€ç™ºé›»é‡ã€è³¼å…¥é‡ã€æ¶ˆè²»é‡ã€ä¾›çµ¦ç‡</p>
        <input type="file" id="fileInput" accept=".csv">
    </div>

    <div id="content" class="hidden">
        <div class="summary-cards" id="summaryCards"></div>

        <div class="chart-container">
            <h2 class="chart-title">ğŸ“Š æ—¥åˆ¥ã‚¨ãƒãƒ«ã‚®ãƒ¼ãƒ•ãƒ­ãƒ¼</h2>
            <canvas id="energyFlowChart"></canvas>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">âš¡ é›»åŠ›åæ”¯ã®å†…è¨³</h2>
            <canvas id="breakdownChart"></canvas>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-bottom: 30px;">
            <div class="chart-container">
                <h2 class="chart-title">ğŸ”‹ è‡ªå®¶æ¶ˆè²»ç‡ã®æ¨ç§»</h2>
                <canvas id="selfConsumptionChart"></canvas>
            </div>

            <div class="chart-container">
                <h2 class="chart-title">ğŸ“ˆ è‡ªçµ¦ç‡ã®æ¨ç§»</h2>
                <canvas id="selfSufficiencyChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">â° æ™‚é–“å¸¯åˆ¥é›»åŠ›æ¨ç§»ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰</h2>
            <canvas id="hourlyChart"></canvas>
        </div>

        <div class="table-container">
            <h2 class="chart-title">ğŸ“‹ æ—¥åˆ¥è©³ç´°ãƒ‡ãƒ¼ã‚¿</h2>
            <table id="detailTable">
                <thead>
                    <tr>
                        <th>æ—¥ä»˜</th>
                        <th>å¤©æ°—</th>
                        <th>ç™ºé›»é‡ (kWh)</th>
                        <th>æ¶ˆè²»é‡ (kWh)</th>
                        <th>è‡ªå®¶æ¶ˆè²» (kWh)</th>
                        <th>è³¼å…¥ (kWh)</th>
                        <th>å£²é›» (kWh)</th>
                        <th>è‡ªçµ¦ç‡ (%)</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let charts = {};
    let hourlyData = [];
    let dailyData = [];

    document.getElementById('fileInput').addEventListener('change', handleFileUpload);

    async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        Papa.parse(file, {
            header: false,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: async function(results) {
                const rows = results.data.slice(1); // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—
                
                // æ™‚é–“åˆ¥ãƒ‡ãƒ¼ã‚¿å‡¦ç†
                hourlyData = rows.map(row => {
                    const year = row[0];
                    const month = row[1];
                    const day = row[2];
                    const hour = row[3];
                    const generation = parseFloat(row[4] || 0);
                    const purchase = parseFloat(row[5] || 0);
                    const consumption = parseFloat(row[6] || 0);
                    const supplyRate = parseFloat(row[7] || 0);
                    
                    const date = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const selfConsumption = Math.min(generation, consumption);
                    const gridExport = Math.max(0, generation - selfConsumption);
                    
                    return {
                        year, month, day, hour, date,
                        generation, purchase, consumption, supplyRate,
                        selfConsumption, gridExport
                    };
                });

                // æ—¥åˆ¥é›†è¨ˆ
                const groupedByDay = {};
                hourlyData.forEach(record => {
                    if (!groupedByDay[record.date]) {
                        groupedByDay[record.date] = [];
                    }
                    groupedByDay[record.date].push(record);
                });

                dailyData = Object.entries(groupedByDay).map(([date, records]) => {
                    const totalGeneration = records.reduce((sum, r) => sum + r.generation, 0);
                    const totalPurchase = records.reduce((sum, r) => sum + r.purchase, 0);
                    const totalConsumption = records.reduce((sum, r) => sum + r.consumption, 0);
                    const totalSelfConsumption = records.reduce((sum, r) => sum + r.selfConsumption, 0);
                    const totalGridExport = records.reduce((sum, r) => sum + r.gridExport, 0);
                    
                    const selfConsumptionRate = totalConsumption > 0 
                        ? (totalSelfConsumption / totalConsumption * 100) 
                        : 0;
                    
                    const selfSufficiencyRate = totalConsumption > 0
                        ? (totalGeneration / totalConsumption * 100)
                        : 0;
                    
                    return {
                        date,
                        totalGeneration: parseFloat(totalGeneration.toFixed(2)),
                        totalPurchase: parseFloat(totalPurchase.toFixed(2)),
                        totalConsumption: parseFloat(totalConsumption.toFixed(2)),
                        totalSelfConsumption: parseFloat(totalSelfConsumption.toFixed(2)),
                        totalGridExport: parseFloat(totalGridExport.toFixed(2)),
                        selfConsumptionRate: parseFloat(selfConsumptionRate.toFixed(1)),
                        selfSufficiencyRate: parseFloat(selfSufficiencyRate.toFixed(1))
                    };
                });

                // ã‚µãƒãƒªãƒ¼è¨ˆç®—
                const totalGen = dailyData.reduce((sum, d) => sum + d.totalGeneration, 0);
                const totalPur = dailyData.reduce((sum, d) => sum + d.totalPurchase, 0);
                const totalCon = dailyData.reduce((sum, d) => sum + d.totalConsumption, 0);
                const totalSelf = dailyData.reduce((sum, d) => sum + d.totalSelfConsumption, 0);
                const totalExport = dailyData.reduce((sum, d) => sum + d.totalGridExport, 0);
                
                const purchasePrice = 30;
                const sellPrice = 17;
                const costSaved = totalSelf * purchasePrice;
                const revenue = totalExport * sellPrice;
                const purchaseCost = totalPur * purchasePrice;
                const netBenefit = costSaved + revenue - purchaseCost;

                const summary = {
                    totalGeneration: totalGen.toFixed(2),
                    totalPurchase: totalPur.toFixed(2),
                    totalConsumption: totalCon.toFixed(2),
                    totalSelfConsumption: totalSelf.toFixed(2),
                    totalGridExport: totalExport.toFixed(2),
                    avgDailyGeneration: (totalGen / dailyData.length).toFixed(2),
                    avgDailyConsumption: (totalCon / dailyData.length).toFixed(2),
                    selfConsumptionRate: ((totalSelf / totalCon * 100)).toFixed(1),
                    selfSufficiencyRate: ((totalGen / totalCon * 100)).toFixed(1),
                    costSaved: Math.round(costSaved),
                    revenue: Math.round(revenue),
                    purchaseCost: Math.round(purchaseCost),
                    netBenefit: Math.round(netBenefit)
                };

                // å¤©æ°—ãƒ‡ãƒ¼ã‚¿å–å¾—
                await fetchWeatherData();
                
                // UIæ›´æ–°
                displaySummary(summary);
                createCharts();
                createTable();
                document.getElementById('content').classList.remove('hidden');
            }
        });
    }

    async function fetchWeatherData() {
        try {
            // ä½ç½®æƒ…å ±å–å¾—
            const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject);
            });
            
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            // å„æ—¥ä»˜ã®å¤©æ°—ã‚’å–å¾—
            for (const day of dailyData) {
                try {
                    const response = await fetch(
                        `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&start_date=${day.date}&end_date=${day.date}&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Asia/Tokyo`
                    );
                    
                    const data = await response.json();
                    
                    if (data.daily) {
                        const weatherCode = data.daily.weather_code[0];
                        day.weather = {
                            description: getWeatherDescription(weatherCode),
                            icon: getWeatherIcon(weatherCode),
                            tempMax: data.daily.temperature_2m_max[0]?.toFixed(1),
                            tempMin: data.daily.temperature_2m_min[0]?.toFixed(1)
                        };
                    }
                } catch (error) {
                    day.weather = estimateWeatherFromGeneration(day.totalGeneration);
                }
            }
        } catch (error) {
            // ä½ç½®æƒ…å ±ãŒå–å¾—ã§ããªã„å ´åˆã¯ç™ºé›»é‡ã‹ã‚‰æ¨å®š
            dailyData.forEach(day => {
                day.weather = estimateWeatherFromGeneration(day.totalGeneration);
            });
        }
    }

    function getWeatherDescription(code) {
        if (code === 0) return 'å¿«æ™´';
        if (code <= 3) return 'æ™´ã‚Œ';
        if (code <= 48) return 'æ›‡ã‚Š';
        if (code <= 67) return 'é›¨';
        if (code <= 77) return 'é›ª';
        return 'æ‚ªå¤©å€™';
    }

    function getWeatherIcon(code) {
        if (code === 0 || code === 1) return 'â˜€ï¸';
        if (code <= 3) return 'â›…';
        if (code <= 48) return 'â˜ï¸';
        if (code <= 67) return 'ğŸŒ§ï¸';
        if (code <= 77) return 'â„ï¸';
        return 'ğŸŒªï¸';
    }

    function estimateWeatherFromGeneration(generation) {
        if (generation > 15) {
            return { description: 'å¿«æ™´', icon: 'â˜€ï¸' };
        } else if (generation > 8) {
            return { description: 'æ™´ã‚Œ', icon: 'â›…' };
        } else if (generation > 3) {
            return { description: 'æ›‡ã‚Š', icon: 'â˜ï¸' };
        } else {
            return { description: 'é›¨', icon: 'ğŸŒ§ï¸' };
        }
    }

    function displaySummary(summary) {
        const cards = [
            { title: 'ç·ç™ºé›»é‡', value: summary.totalGeneration, unit: 'kWh', subtitle: `å¹³å‡ ${summary.avgDailyGeneration} kWh/æ—¥`, gradient: 1 },
            { title: 'è³¼å…¥é›»åŠ›é‡', value: summary.totalPurchase, unit: 'kWh', subtitle: `è²»ç”¨ Â¥${parseInt(summary.purchaseCost).toLocaleString()}`, gradient: 2 },
            { title: 'ç·æ¶ˆè²»é‡', value: summary.totalConsumption, unit: 'kWh', subtitle: `å¹³å‡ ${summary.avgDailyConsumption} kWh/æ—¥`, gradient: 3 },
            { title: 'å£²é›»é‡', value: summary.totalGridExport, unit: 'kWh', subtitle: `åç›Š Â¥${parseInt(summary.revenue).toLocaleString()}`, gradient: 4 },
            { title: 'è‡ªå®¶æ¶ˆè²»ç‡', value: summary.selfConsumptionRate, unit: '%', subtitle: 'æ¶ˆè²»é‡ã®ã†ã¡è‡ªå®¶ç™ºé›»ã§ã‚«ãƒãƒ¼', gradient: 5 },
            { title: 'è‡ªçµ¦ç‡', value: summary.selfSufficiencyRate, unit: '%', subtitle: 'ç™ºé›»é‡ Ã· æ¶ˆè²»é‡', gradient: 1 },
            { title: 'çµŒæ¸ˆåŠ¹æœ', value: `Â¥${parseInt(summary.netBenefit).toLocaleString()}`, unit: '', subtitle: 'ç¯€ç´„é¡ + å£²é›»åç›Š - è³¼å…¥è²»ç”¨', gradient: 2 }
        ];

        const html = cards.map(card => `
            <div class="card card-gradient-${card.gradient}">
                <div class="card-title">${card.title}</div>
                <div class="card-value">${card.value}<span style="font-size: 0.5em">${card.unit}</span></div>
                <div class="card-subtitle">${card.subtitle}</div>
            </div>
        `).join('');

        document.getElementById('summaryCards').innerHTML = html;
    }

    function createCharts() {
        // ã‚¨ãƒãƒ«ã‚®ãƒ¼ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ
        if (charts.energyFlow) charts.energyFlow.destroy();
        const ctx1 = document.getElementById('energyFlowChart').getContext('2d');
        charts.energyFlow = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: dailyData.map(d => d.date),
                datasets: [
                    {
                        label: 'ç™ºé›»é‡',
                        data: dailyData.map(d => d.totalGeneration),
                        borderColor: '#43e97b',
                        backgroundColor: 'rgba(67, 233, 123, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'æ¶ˆè²»é‡',
                        data: dailyData.map(d => d.totalConsumption),
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: true }
                }
            }
        });

        // åæ”¯å†…è¨³ãƒãƒ£ãƒ¼ãƒˆ
        if (charts.breakdown) charts.breakdown.destroy();
        const ctx2 = document.getElementById('breakdownChart').getContext('2d');
        charts.breakdown = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: dailyData.map(d => d.date),
                datasets: [
                    {
                        label: 'è‡ªå®¶æ¶ˆè²»',
                        data: dailyData.map(d => d.totalSelfConsumption),
                        backgroundColor: '#43e97b'
                    },
                    {
                        label: 'è³¼å…¥é›»åŠ›',
                        data: dailyData.map(d => d.totalPurchase),
                        backgroundColor: '#f5576c'
                    },
                    {
                        label: 'å£²é›»',
                        data: dailyData.map(d => d.totalGridExport),
                        backgroundColor: '#667eea'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: true }
                }
            }
        });

        // è‡ªå®¶æ¶ˆè²»ç‡ãƒãƒ£ãƒ¼ãƒˆ
        if (charts.selfConsumption) charts.selfConsumption.destroy();
        const ctx3 = document.getElementById('selfConsumptionChart').getContext('2d');
        charts.selfConsumption = new Chart(ctx3, {
            type: 'line',
            data: {
                labels: dailyData.map(d => d.date),
                datasets: [{
                    label: 'è‡ªå®¶æ¶ˆè²»ç‡ (%)',
                    data: dailyData.map(d => d.selfConsumptionRate),
                    borderColor: '#43e97b',
                    backgroundColor: 'rgba(67, 233, 123, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: { beginAtZero: true, max: 100 }
                }
            }
        });

        // è‡ªçµ¦ç‡ãƒãƒ£ãƒ¼ãƒˆ
        if (charts.selfSufficiency) charts.selfSufficiency.destroy();
        const ctx4 = document.getElementById('selfSufficiencyChart').getContext('2d');
        charts.selfSufficiency = new Chart(ctx4, {
            type: 'line',
            data: {
                labels: dailyData.map(d => d.date),
                datasets: [{
                    label: 'è‡ªçµ¦ç‡ (%)',
                    data: dailyData.map(d => d.selfSufficiencyRate),
                    borderColor: '#4facfe',
                    backgroundColor: 'rgba(79, 172, 254, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        // æ™‚é–“å¸¯åˆ¥ãƒãƒ£ãƒ¼ãƒˆï¼ˆæœ€åˆã®72æ™‚é–“ï¼‰
        if (charts.hourly) charts.hourly.destroy();
        const ctx5 = document.getElementById('hourlyChart').getContext('2d');
        const hourlySlice = hourlyData.slice(0, 72);
        charts.hourly = new Chart(ctx5, {
            type: 'line',
            data: {
                labels: hourlySlice.map(h => `${h.hour}æ™‚`),
                datasets: [
                    {
                        label: 'ç™ºé›»',
                        data: hourlySlice.map(h => h.generation),
                        borderColor: '#43e97b',
                        tension: 0.4
                    },
                    {
                        label: 'æ¶ˆè²»',
                        data: hourlySlice.map(h => h.consumption),
                        borderColor: '#4facfe',
                        tension: 0.4
                    },
                    {
                        label: 'è³¼å…¥',
                        data: hourlySlice.map(h => h.purchase),
                        borderColor: '#f5576c',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true
            }
        });
    }

    function createTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = dailyData.map(row => `
            <tr>
                <td>${row.date}</td>
                <td>
                    <div class="weather-cell">
                        <span class="weather-icon">${row.weather?.icon || 'â“'}</span>
                        <div>
                            <div>${row.weather?.description || '-'}</div>
                            ${row.weather?.tempMax ? `<div style="font-size: 0.8em; color: #666;">${row.weather.tempMax}Â°C / ${row.weather.tempMin}Â°C</div>` : ''}
                        </div>
                    </div>
                </td>
                <td style="color: #43e97b; font-weight: bold;">${row.totalGeneration}</td>
                <td style="color: #4facfe; font-weight: bold;">${row.totalConsumption}</td>
                <td style="color: #38f9d7;">${row.totalSelfConsumption}</td>
                <td style="color: #f5576c;">${row.totalPurchase}</td>
                <td style="color: #667eea;">${row.totalGridExport}</td>
                <td style="font-weight: bold; color: #764ba2;">${row.selfSufficiencyRate}%</td>
            </tr>
        `).join('');
    }
</script>
```

</body>
</html>
