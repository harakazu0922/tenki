import React, { useState } from ‘react’;
import { LineChart, Line, BarChart, Bar, AreaChart, Area, PieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from ‘recharts’;
import { Upload, Sun, Cloud, CloudRain, CloudSnow, Wind, TrendingUp, TrendingDown, Zap, DollarSign, Battery } from ‘lucide-react’;
import Papa from ‘papaparse’;
import _ from ‘lodash’;

export default function SolarDashboard() {
const [hourlyData, setHourlyData] = useState([]);
const [dailyData, setDailyData] = useState([]);
const [summary, setSummary] = useState(null);
const [weatherData, setWeatherData] = useState({});
const [location, setLocation] = useState(null);

const handleFileUpload = async (e) => {
const file = e.target.files[0];
if (!file) return;

```
Papa.parse(file, {
  header: false,
  dynamicTyping: true,
  skipEmptyLines: true,
  complete: async (results) => {
    const rows = results.data.slice(1); // ヘッダーをスキップ
    
    const processedHourly = rows.map(row => {
      const year = row[0];
      const month = row[1];
      const day = row[2];
      const hour = row[3];
      const generation = parseFloat(row[4] || 0);
      const purchase = parseFloat(row[5] || 0);
      const consumption = parseFloat(row[6] || 0);
      const supplyRate = parseFloat(row[7] || 0);
      
      const date = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      const datetime = `${date} ${String(hour).padStart(2, '0')}:00`;
      
      // 売電量 = 発電量 - 自家消費量
      const selfConsumption = Math.min(generation, consumption);
      const gridExport = Math.max(0, generation - selfConsumption);
      const netPurchase = Math.max(0, consumption - generation);
      
      return {
        year, month, day, hour, date, datetime,
        generation, purchase, consumption, supplyRate,
        selfConsumption, gridExport, netPurchase
      };
    });

    setHourlyData(processedHourly);

    // 日別集計
    const groupedByDay = _.groupBy(processedHourly, 'date');
    const dailyAgg = Object.entries(groupedByDay).map(([date, records]) => {
      const totalGeneration = _.sumBy(records, 'generation');
      const totalPurchase = _.sumBy(records, 'purchase');
      const totalConsumption = _.sumBy(records, 'consumption');
      const totalSelfConsumption = _.sumBy(records, 'selfConsumption');
      const totalGridExport = _.sumBy(records, 'gridExport');
      
      const selfConsumptionRate = totalConsumption > 0 
        ? (totalSelfConsumption / totalConsumption * 100) 
        : 0;
      
      const selfSufficiencyRate = totalConsumption > 0
        ? (totalGeneration / totalConsumption * 100)
        : 0;

      const peakGeneration = _.maxBy(records, 'generation')?.generation || 0;
      const peakConsumption = _.maxBy(records, 'consumption')?.consumption || 0;
      
      return {
        date,
        totalGeneration: parseFloat(totalGeneration.toFixed(2)),
        totalPurchase: parseFloat(totalPurchase.toFixed(2)),
        totalConsumption: parseFloat(totalConsumption.toFixed(2)),
        totalSelfConsumption: parseFloat(totalSelfConsumption.toFixed(2)),
        totalGridExport: parseFloat(totalGridExport.toFixed(2)),
        selfConsumptionRate: parseFloat(selfConsumptionRate.toFixed(1)),
        selfSufficiencyRate: parseFloat(selfSufficiencyRate.toFixed(1)),
        peakGeneration: parseFloat(peakGeneration.toFixed(2)),
        peakConsumption: parseFloat(peakConsumption.toFixed(2)),
        records
      };
    });

    setDailyData(dailyAgg);

    // 全体サマリー
    const totalGen = _.sumBy(dailyAgg, 'totalGeneration');
    const totalPur = _.sumBy(dailyAgg, 'totalPurchase');
    const totalCon = _.sumBy(dailyAgg, 'totalConsumption');
    const totalSelf = _.sumBy(dailyAgg, 'totalSelfConsumption');
    const totalExport = _.sumBy(dailyAgg, 'totalGridExport');
    
    const avgDailyGen = totalGen / dailyAgg.length;
    const avgDailyCon = totalCon / dailyAgg.length;
    const overallSelfConsumptionRate = (totalSelf / totalCon * 100);
    const overallSelfSufficiencyRate = (totalGen / totalCon * 100);
    
    // 経済計算 (仮の電気料金)
    const purchasePrice = 30; // 円/kWh (買電単価)
    const sellPrice = 17; // 円/kWh (売電単価)
    const costSaved = totalSelf * purchasePrice;
    const revenue = totalExport * sellPrice;
    const purchaseCost = totalPur * purchasePrice;
    const netBenefit = costSaved + revenue - purchaseCost;

    setSummary({
      totalGeneration: totalGen.toFixed(2),
      totalPurchase: totalPur.toFixed(2),
      totalConsumption: totalCon.toFixed(2),
      totalSelfConsumption: totalSelf.toFixed(2),
      totalGridExport: totalExport.toFixed(2),
      avgDailyGeneration: avgDailyGen.toFixed(2),
      avgDailyConsumption: avgDailyCon.toFixed(2),
      selfConsumptionRate: overallSelfConsumptionRate.toFixed(1),
      selfSufficiencyRate: overallSelfSufficiencyRate.toFixed(1),
      days: dailyAgg.length,
      costSaved: Math.round(costSaved),
      revenue: Math.round(revenue),
      purchaseCost: Math.round(purchaseCost),
      netBenefit: Math.round(netBenefit)
    });

    // 天気データ取得
    await fetchWeatherData(dailyAgg);
  }
});
```

};

const fetchWeatherData = async (dailyAgg) => {
// ユーザーの位置情報を取得
try {
const position = await new Promise((resolve, reject) => {
navigator.geolocation.getCurrentPosition(resolve, reject);
});

```
  const lat = position.coords.latitude;
  const lon = position.coords.longitude;
  setLocation({ lat, lon });

  // 各日付の天気を取得
  const weatherMap = {};
  
  for (const day of dailyAgg) {
    try {
      // Open-Meteo API（無料の天気API）を使用
      const dateObj = new Date(day.date);
      const formattedDate = day.date;
      
      const response = await fetch(
        `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&start_date=${formattedDate}&end_date=${formattedDate}&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,wind_speed_10m_max&timezone=Asia/Tokyo`
      );
      
      const data = await response.json();
      
      if (data.daily) {
        const weatherCode = data.daily.weather_code[0];
        const tempMax = data.daily.temperature_2m_max[0];
        const tempMin = data.daily.temperature_2m_min[0];
        const precipitation = data.daily.precipitation_sum[0];
        const windSpeed = data.daily.wind_speed_10m_max[0];
        
        weatherMap[day.date] = {
          code: weatherCode,
          description: getWeatherDescription(weatherCode),
          icon: getWeatherIcon(weatherCode),
          tempMax: tempMax?.toFixed(1),
          tempMin: tempMin?.toFixed(1),
          precipitation: precipitation?.toFixed(1),
          windSpeed: windSpeed?.toFixed(1)
        };
      }
    } catch (error) {
      console.error(`天気データ取得エラー (${day.date}):`, error);
      // フォールバック: 発電量から推定
      weatherMap[day.date] = estimateWeatherFromGeneration(day.totalGeneration);
    }
  }
  
  setWeatherData(weatherMap);
  
  // 天気情報を日別データに追加
  const updatedDaily = dailyAgg.map(day => ({
    ...day,
    weather: weatherMap[day.date]
  }));
  setDailyData(updatedDaily);
  
} catch (error) {
  console.error('位置情報または天気データ取得エラー:', error);
  // フォールバック: 発電量から推定
  const weatherMap = {};
  dailyAgg.forEach(day => {
    weatherMap[day.date] = estimateWeatherFromGeneration(day.totalGeneration);
  });
  setWeatherData(weatherMap);
  
  const updatedDaily = dailyAgg.map(day => ({
    ...day,
    weather: weatherMap[day.date]
  }));
  setDailyData(updatedDaily);
}
```

};

const getWeatherDescription = (code) => {
if (code === 0) return ‘快晴’;
if (code <= 3) return ‘晴れ’;
if (code <= 48) return ‘曇り’;
if (code <= 67) return ‘雨’;
if (code <= 77) return ‘雪’;
if (code <= 82) return ‘雨’;
return ‘悪天候’;
};

const getWeatherIcon = (code) => {
if (code === 0 || code === 1) return Sun;
if (code <= 3) return Cloud;
if (code <= 67 || code <= 82) return CloudRain;
if (code <= 77) return CloudSnow;
return Wind;
};

const estimateWeatherFromGeneration = (generation) => {
if (generation > 15) {
return { description: ‘快晴’, icon: Sun, code: 0 };
} else if (generation > 8) {
return { description: ‘晴れ’, icon: Cloud, code: 2 };
} else if (generation > 3) {
return { description: ‘曇り’, icon: Cloud, code: 3 };
} else {
return { description: ‘雨’, icon: CloudRain, code: 61 };
}
};

const renderWeatherIcon = (weather) => {
if (!weather) return <Wind className="w-5 h-5 text-gray-400" />;
const IconComponent = weather.icon;
const colorClass =
weather.code === 0 ? ‘text-yellow-500’ :
weather.code <= 3 ? ‘text-yellow-400’ :
weather.code <= 48 ? ‘text-gray-500’ :
weather.code <= 67 ? ‘text-blue-500’ :
‘text-blue-700’;
return <IconComponent className={`w-5 h-5 ${colorClass}`} />;
};

const COLORS = [’#10b981’, ‘#f59e0b’, ‘#3b82f6’, ‘#8b5cf6’, ‘#ec4899’];

return (
<div className="min-h-screen bg-gradient-to-br from-blue-50 via-green-50 to-yellow-50 p-4 md:p-8">
<div className="max-w-7xl mx-auto">
<header className="mb-8 text-center">
<h1 className="text-5xl font-bold text-gray-800 mb-3 flex items-center justify-center gap-3">
<Sun className="w-12 h-12 text-yellow-500" />
太陽光発電分析ダッシュボード
</h1>
<p className="text-gray-600 text-lg">詳細な発電データと経済分析</p>
</header>

```
    {/* ファイルアップロード */}
    <div className="bg-white rounded-xl shadow-lg p-6 mb-8 border-2 border-gray-100">
      <label className="flex flex-col items-center justify-center w-full h-40 border-3 border-dashed border-blue-300 rounded-xl cursor-pointer hover:bg-blue-50 transition-all duration-300">
        <div className="flex flex-col items-center justify-center">
          <Upload className="w-12 h-12 text-blue-500 mb-3" />
          <p className="text-lg font-semibold text-gray-700">CSVファイルをアップロード</p>
          <p className="text-sm text-gray-500 mt-2">
            年、月、日、時間、発電量、購入量、消費量、供給率
          </p>
        </div>
        <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden" />
      </label>
    </div>

    {/* サマリーカード */}
    {summary && (
      <>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
            <div className="flex items-center justify-between mb-2">
              <div className="text-sm font-medium opacity-90">総発電量</div>
              <Zap className="w-6 h-6 opacity-80" />
            </div>
            <div className="text-3xl font-bold">{summary.totalGeneration}</div>
            <div className="text-sm opacity-90 mt-1">kWh</div>
            <div className="text-xs opacity-75 mt-2">平均 {summary.avgDailyGeneration} kWh/日</div>
          </div>

          <div className="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white">
            <div className="flex items-center justify-between mb-2">
              <div className="text-sm font-medium opacity-90">購入電力量</div>
              <TrendingDown className="w-6 h-6 opacity-80" />
            </div>
            <div className="text-3xl font-bold">{summary.totalPurchase}</div>
            <div className="text-sm opacity-90 mt-1">kWh</div>
            <div className="text-xs opacity-75 mt-2">費用 ¥{summary.purchaseCost.toLocaleString()}</div>
          </div>

          <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
            <div className="flex items-center justify-between mb-2">
              <div className="text-sm font-medium opacity-90">総消費量</div>
              <Battery className="w-6 h-6 opacity-80" />
            </div>
            <div className="text-3xl font-bold">{summary.totalConsumption}</div>
            <div className="text-sm opacity-90 mt-1">kWh</div>
            <div className="text-xs opacity-75 mt-2">平均 {summary.avgDailyConsumption} kWh/日</div>
          </div>

          <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
            <div className="flex items-center justify-between mb-2">
              <div className="text-sm font-medium opacity-90">売電量</div>
              <TrendingUp className="w-6 h-6 opacity-80" />
            </div>
            <div className="text-3xl font-bold">{summary.totalGridExport}</div>
            <div className="text-sm opacity-90 mt-1">kWh</div>
            <div className="text-xs opacity-75 mt-2">収益 ¥{summary.revenue.toLocaleString()}</div>
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
            <div className="text-sm text-gray-600 mb-2">自家消費率</div>
            <div className="text-4xl font-bold text-green-600">{summary.selfConsumptionRate}%</div>
            <div className="text-xs text-gray-500 mt-2">消費量のうち自家発電でカバー</div>
          </div>

          <div className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
            <div className="text-sm text-gray-600 mb-2">自給率</div>
            <div className="text-4xl font-bold text-blue-600">{summary.selfSufficiencyRate}%</div>
            <div className="text-xs text-gray-500 mt-2">発電量 ÷ 消費量</div>
          </div>

          <div className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-yellow-500">
            <div className="text-sm text-gray-600 mb-2">経済効果</div>
            <div className="text-4xl font-bold text-yellow-600">¥{summary.netBenefit.toLocaleString()}</div>
            <div className="text-xs text-gray-500 mt-2">節約額 + 売電収益 - 購入費用</div>
          </div>
        </div>
      </>
    )}

    {/* グラフセクション */}
    {dailyData.length > 0 && (
      <>
        {/* 日別エネルギーフロー */}
        <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
          <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            <TrendingUp className="w-6 h-6 text-green-600" />
            日別エネルギーフロー
          </h2>
          <ResponsiveContainer width="100%" height={400}>
            <AreaChart data={dailyData}>
              <defs>
                <linearGradient id="colorGen" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor="#10b981" stopOpacity={0.8}/>
                  <stop offset="95%" stopColor="#10b981" stopOpacity={0.1}/>
                </linearGradient>
                <linearGradient id="colorCon" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.8}/>
                  <stop offset="95%" stopColor="#3b82f6" stopOpacity={0.1}/>
                </linearGradient>
              </defs>
              <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
              <XAxis dataKey="date" stroke="#6b7280" />
              <YAxis stroke="#6b7280" label={{ value: 'kWh', angle: -90, position: 'insideLeft' }} />
              <Tooltip contentStyle={{ backgroundColor: '#fff', border: '1px solid #e5e7eb', borderRadius: '8px' }} />
              <Legend />
              <Area type="monotone" dataKey="totalGeneration" stroke="#10b981" fillOpacity={1} fill="url(#colorGen)" name="発電量" strokeWidth={2} />
              <Area type="monotone" dataKey="totalConsumption" stroke="#3b82f6" fillOpacity={1} fill="url(#colorCon)" name="消費量" strokeWidth={2} />
            </AreaChart>
          </ResponsiveContainer>
        </div>

        {/* 購入・売電・自家消費 */}
        <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
          <h2 className="text-2xl font-bold text-gray-800 mb-4">電力収支の内訳</h2>
          <ResponsiveContainer width="100%" height={400}>
            <BarChart data={dailyData}>
              <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
              <XAxis dataKey="date" stroke="#6b7280" />
              <YAxis stroke="#6b7280" label={{ value: 'kWh', angle: -90, position: 'insideLeft' }} />
              <Tooltip contentStyle={{ backgroundColor: '#fff', border: '1px solid #e5e7eb', borderRadius: '8px' }} />
              <Legend />
              <Bar dataKey="totalSelfConsumption" fill="#10b981" name="自家消費" stackId="a" />
              <Bar dataKey="totalPurchase" fill="#f59e0b" name="購入電力" stackId="a" />
              <Bar dataKey="totalGridExport" fill="#8b5cf6" name="売電" />
            </BarChart>
          </ResponsiveContainer>
        </div>

        {/* 自給率と自家消費率 */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
          <div className="bg-white rounded-xl shadow-lg p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">自家消費率の推移</h2>
            <ResponsiveContainer width="100%" height={300}>
              <LineChart data={dailyData}>
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis dataKey="date" stroke="#6b7280" />
                <YAxis stroke="#6b7280" domain={[0, 100]} label={{ value: '%', angle: -90, position: 'insideLeft' }} />
                <Tooltip contentStyle={{ backgroundColor: '#fff', border: '1px solid #e5e7eb', borderRadius: '8px' }} />
                <Legend />
                <Line type="monotone" dataKey="selfConsumptionRate" stroke="#10b981" strokeWidth={3} name="自家消費率 (%)" dot={{ r: 4 }} />
              </LineChart>
            </ResponsiveContainer>
          </div>

          <div className="bg-white rounded-xl shadow-lg p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">自給率の推移</h2>
            <ResponsiveContainer width="100%" height={300}>
              <LineChart data={dailyData}>
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis dataKey="date" stroke="#6b7280" />
                <YAxis stroke="#6b7280" domain={[0, 'auto']} label={{ value: '%', angle: -90, position: 'insideLeft' }} />
                <Tooltip contentStyle={{ backgroundColor: '#fff', border: '1px solid #e5e7eb', borderRadius: '8px' }} />
                <Legend />
                <Line type="monotone" dataKey="selfSufficiencyRate" stroke="#3b82f6" strokeWidth={3} name="自給率 (%)" dot={{ r: 4 }} />
              </LineChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* 時間帯別分析（最初の3日分） */}
        {hourlyData.length > 0 && (
          <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">時間帯別電力推移（サンプル）</h2>
            <ResponsiveContainer width="100%" height={350}>
              <LineChart data={hourlyData.slice(0, 72)}>
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis dataKey="hour" stroke="#6b7280" label={{ value: '時', position: 'insideBottom', offset: -5 }} />
                <YAxis stroke="#6b7280" label={{ value: 'kWh', angle: -90, position: 'insideLeft' }} />
                <Tooltip contentStyle={{ backgroundColor: '#fff', border: '1px solid #e5e7eb', borderRadius: '8px' }} />
                <Legend />
                <Line type="monotone" dataKey="generation" stroke="#10b981" name="発電" strokeWidth={2} />
                <Line type="monotone" dataKey="consumption" stroke="#3b82f6" name="消費" strokeWidth={2} />
                <Line type="monotone" dataKey="purchase" stroke="#f59e0b" name="購入" strokeWidth={2} />
              </LineChart>
            </ResponsiveContainer>
          </div>
        )}

        {/* 日別詳細テーブル */}
        <div className="bg-white rounded-xl shadow-lg p-6">
          <h2 className="text-2xl font-bold text-gray-800 mb-4">日別詳細データ</h2>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="border-b-2 border-gray-200 bg-gray-50">
                  <th className="text-left p-3 font-semibold">日付</th>
                  <th className="text-left p-3 font-semibold">天気</th>
                  <th className="text-right p-3 font-semibold">発電量</th>
                  <th className="text-right p-3 font-semibold">消費量</th>
                  <th className="text-right p-3 font-semibold">自家消費</th>
                  <th className="text-right p-3 font-semibold">購入</th>
                  <th className="text-right p-3 font-semibold">売電</th>
                  <th className="text-right p-3 font-semibold">自給率</th>
                </tr>
              </thead>
              <tbody>
                {dailyData.map((row, idx) => (
                  <tr key={idx} className="border-b border-gray-100 hover:bg-blue-50 transition-colors">
                    <td className="p-3 font-medium">{row.date}</td>
                    <td className="p-3">
                      <div className="flex items-center gap-2">
                        {renderWeatherIcon(row.weather)}
                        <div>
                          <div className="text-sm font-medium">{row.weather?.description || '-'}</div>
                          {row.weather?.tempMax && (
                            <div className="text-xs text-gray-500">
                              {row.weather.tempMax}°C / {row.weather.tempMin}°C
                            </div>
                          )}
                        </div>
                      </div>
                    </td>
                    <td className="text-right p-3 text-green-600 font-semibold">{row.totalGeneration}</td>
                    <td className="text-right p-3 text-blue-600 font-semibold">{row.totalConsumption}</td>
                    <td className="text-right p-3 text-emerald-600">{row.totalSelfConsumption}</td>
                    <td className="text-right p-3 text-orange-600">{row.totalPurchase}</td>
                    <td className="text-right p-3 text-purple-600">{row.totalGridExport}</td>
                    <td className="text-right p-3 font-semibold text-blue-700">{row.selfSufficiencyRate}%</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </>
    )}

    {hourlyData.length === 0 && (
      <div className="bg-white rounded-xl shadow-lg p-16 text-center">
        <Sun className="w-20 h-20 text-gray-300 mx-auto mb-4" />
        <p className="text-xl text-gray-500 mb-2">CSVファイルをアップロードしてください</p>
        <p className="text-sm text-gray-400">
          年、月、日、時間、発電量、購入量、消費量、供給率の形式
        </p>
      </div>
    )}
  </div>
</div>
```

);
}
